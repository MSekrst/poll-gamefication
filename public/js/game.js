'use strict';const doc=$(document),screenWidth=doc.width()-2,screenHeight=doc.height()-155,sizeFactor=screenHeight/80,carSpeed=1;class GameComponent{constructor(a){a.url&&(this.image=new Image,this.image.src=a.url),a.color&&(this.color=a.color),this.width=0|a.width+0.5,this.height=0|a.height+0.5,this.speedX=0,this.speedY=0,this.x=a.x,this.y=a.y}update(){const a=gameArea.context;this.image?a.drawImage(this.image,this.x,this.y,this.width,this.height):(a.fillStyle=this.color,a.fillRect(this.x,this.y,this.width,this.height))}crashWith(a){if(!this||!a)return!1;const b=this.x,c=this.x+this.width,d=this.y,f=this.y+this.height,g=a.x,h=a.x+a.width,k=a.y,l=a.y+a.height;let m=!0;return(f<k||d>l||c<g||b>h)&&(m=!1),m}}class GameArea{constructor(){this.canvas=document.createElement('canvas')}start(){this.canvas.width=screenWidth,this.canvas.height=screenHeight,this.context=this.canvas.getContext('2d'),$('#game-container').html(this.canvas),this.interval=setInterval(updateGameArea,30)}restart(){this.interval=setInterval(updateGameArea,4*pollPickups.length)}clear(){this.context.clearRect(0,0,screenWidth,screenHeight)}stop(){clearInterval(this.interval)}}let pollPickups=[],parkingSpaces=[];const columnWithTwo=Math.floor(2*Math.random()),numberOfSpaces=Math.round((screenHeight-50)/(5*sizeFactor+3*(2*sizeFactor)+10));let grass=new GameComponent({width:3*sizeFactor,height:screenHeight-5*sizeFactor+10,url:'/anketa/images/grass.png',x:0,y:5*sizeFactor+10});parkingSpaces.push(grass),grass=new GameComponent({width:3*sizeFactor,height:screenHeight-5*sizeFactor+10,url:'/anketa/images/grass.png',x:screenWidth-3*sizeFactor,y:5*sizeFactor+10}),parkingSpaces.push(grass);for(let a=0;3>a;a++){let b,c,d,f=grass.width;if(1===a?(f=screenWidth/6/2,f=screenWidth/2-f):2==a&&(f=screenWidth-screenWidth/6-grass.width),columnWithTwo===a)for(b=Math.floor(Math.random()*(numberOfSpaces-1)),c=Math.floor(Math.random()*(numberOfSpaces-1));c==b;)c=Math.floor(Math.random()*(numberOfSpaces-1));else{for(b=Math.floor(Math.random()*(numberOfSpaces-1)),c=Math.floor(Math.random()*(numberOfSpaces-1));c==b;)c=Math.floor(Math.random()*(numberOfSpaces-1));for(d=Math.floor(Math.random()*(numberOfSpaces-1));d==b||d===c;)d=Math.floor(Math.random()*(numberOfSpaces-1))}for(let g=0;g<numberOfSpaces;g++){const h=new GameComponent({width:screenWidth/6,height:3*sizeFactor,color:'white',x:f,y:5*sizeFactor+10+g*screenHeight/numberOfSpaces});if(parkingSpaces.push(h),g===b||g===c||columnWithTwo!=a&&g==d){const k=new GameComponent({width:Math.round(5*sizeFactor),height:Math.round(5*sizeFactor),url:'/anketa/images/munja.png',x:f+screenWidth/12-Math.round(5*sizeFactor)/2,y:h.y+h.height+(screenHeight/numberOfSpaces-h.height)/2-Math.round(5*sizeFactor)/2});pollPickups.push(k)}}}var gameArea=new GameArea;let car;var startGame=()=>{car=new GameComponent({width:10*sizeFactor,height:5*sizeFactor,url:'/anketa/images/car'+user.sex+'.png',x:0,y:0}),gameArea.start()};function updateGameArea(){gameArea.clear();const a=[];pollPickups.forEach(b=>{car.crashWith(b)?(gameArea.stop(),newPoll(),car.x+=car.speedX,car.y+=car.speedY,clearMove()):(b.update(),a.push(b),0<=car.x&&car.x<=screenWidth-car.width&&(car.x+=car.speedX),0>car.x&&(car.x=0),car.x>screenWidth-car.width&&(car.x=screenWidth-car.width),0<=car.y&&car.y<=screenHeight-car.height&&(car.y+=car.speedY),0>car.y&&(car.y=0),car.y>screenHeight-car.height&&(car.y=screenHeight-car.height)),parkingSpaces.forEach(c=>{car&&(car.crashWith(c)&&(1===car.speedX&&(car.x-=1,clearMove()),-1===car.speedX&&(car.x+=1,clearMove()),1===car.speedY&&(car.y-=1,clearMove()),-1===car.speedY&&(car.y+=1,clearMove())),c.update())}),car.update()}),pollPickups=a}function moveUp(){car&&(car.speedY=-carSpeed,!upBtn.hasClass('btn-success')&&upBtn.addClass('btn-success'))}function moveDown(){car&&(car.speedY=carSpeed,!downBtn.hasClass('btn-success')&&downBtn.addClass('btn-success'))}function moveLeft(){car&&(car.speedX=-carSpeed,!leftBtn.hasClass('btn-success')&&leftBtn.addClass('btn-success'))}function moveRight(){car&&(car.speedX=carSpeed,!rightBtn.hasClass('btn-success')&&rightBtn.addClass('btn-success'))}function clearMove(){car&&(car.speedX=0,car.speedY=0,upBtn.removeClass('btn-success'),leftBtn.removeClass('btn-success'),rightBtn.removeClass('btn-success'),downBtn.removeClass('btn-success'))}const pollElement=$('#poll'),pollSubmitElement=$('#poll-submit'),helpModal=$('#help-modal'),helpSubmit=$('#help-submit');doc.keydown(a=>{const b=a.keyCode?a.keyCode:a.which;if(13===b){if($('#user-modal').is(':visible')&&!$('#user-submit').is(':disabled'))$('#user-submit').click();else{if(pollElement.is(':visible')&&!pollSubmitElement.is(':disabled'))return pollSubmitElement.click(),clearMove();if(helpModal.is(':visible'))return helpSubmit.click(),clearMove()}}else if(!pollElement.is(':visible')||!helpModal.is(':visible'))return 38===b?moveUp():40===b?moveDown():37===b?moveLeft():39===b?moveRight():clearMove()}),doc.keyup(()=>{clearMove()});const upBtn=$('#move-up'),leftBtn=$('#move-left'),rightBtn=$('#move-right'),downBtn=$('#move-down');upBtn.on('mousedown touchstart',moveUp),upBtn.mouseup(clearMove),leftBtn.on('mousedown touchstart',moveLeft),leftBtn.mouseup(clearMove),rightBtn.on('mousedown touchstart',moveRight),rightBtn.mouseup(clearMove),downBtn.on('mousedown touchstart',moveDown),downBtn.mouseup(clearMove);const showHelp=()=>{helpModal.modal('show')};$('#help-button').on('click touch',showHelp),helpSubmit.on('click touch',()=>{helpModal.modal('hide'),timeGame||(timeGame=new Date().getTime())});
